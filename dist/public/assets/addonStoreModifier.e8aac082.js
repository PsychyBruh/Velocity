import{A as d,R as p}from"./RuntimeModifier.729da609.js";import{U as r,V as o,W as u,X as f,Y as m}from"./index.596163ac.js";import{r as E}from"./Tab.baaf254f.js";import{o as v}from"./index.e8530d6e.js";import"./BareClient.06787bc0.js";import"./url.064866d1.js";const c=await v("addons",1,{upgrade(n){n.createObjectStore("addons",{keyPath:"id"})}}),y=c.transaction("addons","readwrite"),b=y.objectStore("addons");r(await b.getAll());o().forEach(async n=>{await l(n)});async function g(n,e){const t=await n.extractManifest();if(window.confirm(`This site would like to install an add-on in Velocity: 
 ${t.short_name??t.name}`)){const s={canUninstall:!0,id:await n.id??t.name,isActive:!0,isEnabled:!0,name:t.name,type:t.theme?"theme":"extension",version:t.version,description:t.description,archive:e};return s.type==="theme"&&r(o().map(a=>(a.type==="theme"&&(a.isActive=!1,a.isEnabled=!1),a))),r([s,...o()]),h(),await l(s,n,t),await n.id}else throw new Error("User prevented installation.")}function A(n){return new Promise(async(e,t)=>{n.canUninstall?(n.type==="theme"&&n.isActive&&n.isEnabled&&(localStorage.setItem("theme",""),f(m)),r(o().filter(s=>s.id!==n.id)),await h(),window.confirm("Action may require page reload.")?(location.reload(),e()):(console.warn("Addon may still be running in the background, in order to ensure the addon is fully uninstalled please reload the tab."),e())):t()})}async function l(n,e,t){e=e??new d(n.archive),await e.ready,t=t??await e.extractManifest(),n.type==="theme"?n.isActive&&u(t,e):n.isEnabled&&t.content_scripts&&x(t.content_scripts,t.permissions??[],e)}function x(n,e,t){n.forEach(async s=>{s.js&&(s.js=s.js.map(async a=>t.extractFile(a,"text"))),s.css&&(s.css=s.css.map(async a=>t.extractFile(a,"text"))),E(s,e??[])})}async function h(){const e=c.transaction("addons","readwrite").objectStore("addons");await e.clear();for(const t of o())await e.put(t);return Promise.resolve()}const j=new p("addonstore");class i extends Event{id;constructor(e,t){super(e),this.id=t}}class D extends EventTarget{abuseReportPanelEnabled=!1;constructor(){super()}async createInstall(e){const t=this;return new class extends EventTarget{async install(){const a=new d(e.url);this.dispatchEvent(new Event("onDownloadStarted")),a.ready.then(async()=>{this.dispatchEvent(new Event("onDownloadEnded")),this.dispatchEvent(new Event("onInstallStarted")),g(a,e.url).then(w=>{this.dispatchEvent(new Event("onInstallEnded")),t.dispatchEvent(new i("onInstalled",w))}).catch(()=>{this.dispatchEvent(new Event("onInstallCancelled"))})}).catch(()=>{this.dispatchEvent(new Event("onDownloadFailed"))})}}}async getAddonByID(e){const t=o().find(s=>s.id===e);return t?Object.assign({uninstall:()=>{this.dispatchEvent(new i("onUninstalling",e)),A(t).then(()=>{this.dispatchEvent(new i("onUninstalled",e))}).catch(()=>{})},setEnabled:s=>{s?(this.dispatchEvent(new i("onEnabling",e)),setTimeout(()=>{this.dispatchEvent(new i("onEnabled",e))},1e3)):(this.dispatchEvent(new i("onDisabling",e)),setTimeout(()=>{this.dispatchEvent(new i("onDisabled",e))},1e3))}},t):void 0}reportAbuse(){}}j.createInject("*://addons.mozilla.org/*",({navigator:n})=>{const e=new D;Object.defineProperty(n,"mozAddonManager",{get(){return e}})});
